---
/**
 * NotionBlocks 元件：負責分發與渲染 Notion 回傳的各類型內容區塊 (Blocks)。
 * 它透過迴圈檢查每個 Block 的 Type，再將其傳入對應的子元件 (如 Paragraph.astro、Image.astro 等) 進行渲染。
 */
import * as interfaces from '../lib/interfaces.ts'
import {
  isTweetURL,
  isAmazonURL,
  buildURLToHTMLMap,
} from '../lib/blog-helpers.ts'
import Paragraph from './notion-blocks/Paragraph.astro'
import Heading1 from './notion-blocks/Heading1.astro'
import Heading2 from './notion-blocks/Heading2.astro'
import Heading3 from './notion-blocks/Heading3.astro'
import TableOfContents from './notion-blocks/TableOfContents.astro'
import Image from './notion-blocks/Image.astro'
import Video from './notion-blocks/Video.astro'
import Code from './notion-blocks/Code.astro'
import Quote from './notion-blocks/Quote.astro'
import Equation from './notion-blocks/Equation.astro'
import Callout from './notion-blocks/Callout.astro'
import Embed from './notion-blocks/Embed.astro'
import Bookmark from './notion-blocks/Bookmark.astro'
import Divider from './notion-blocks/Divider.astro'
import Table from './notion-blocks/Table.astro'
import ColumnList from './notion-blocks/ColumnList.astro'
import BulletedListItems from './notion-blocks/BulletedListItems.astro'
import NumberedListItems from './notion-blocks/NumberedListItems.astro'
import ToDo from './notion-blocks/ToDo.astro'
import SyncedBlock from './notion-blocks/SyncedBlock.astro'
import Toggle from './notion-blocks/Toggle.astro'
import File from './notion-blocks/File.astro'
import LinkToPage from './notion-blocks/LinkToPage.astro'

export interface Props {
  blocks: interfaces.Block[]
  isRoot?: boolean
  level?: number
  headings?: interfaces.Block[]
}

// 接收外部傳入的 blocks 陣列以及層級參數
const {
  blocks: rawBlocks,
  isRoot = false,
  level = 1,
  headings: rawHeadings = [],
} = Astro.props

// 把連續的條列項目 (bulleted_list_item, numbered_list_item, to_do) 群組成 list 類型
const blocks = rawBlocks.reduce(
  (arr: (interfaces.Block | interfaces.List)[], block: interfaces.Block, i: number) => {
  const isBulletedListItem = block.Type === 'bulleted_list_item'
  const isNumberedListItem = block.Type === 'numbered_list_item'
  const isToDo = block.Type === 'to_do'

  if (!isBulletedListItem && !isNumberedListItem && !isToDo) {
    return arr.concat(block)
  }

  const listType = isBulletedListItem
    ? 'bulleted_list'
    : isNumberedListItem
      ? 'numbered_list'
      : 'to_do_list'

  if (i === 0) {
    const list: interfaces.List = {
      Type: listType,
      ListItems: [block],
    }
    return arr.concat(list)
  }

  const prevList = arr[arr.length - 1] as interfaces.List | undefined
  if (!prevList || !('ListItems' in prevList)) {
    const list: interfaces.List = {
      Type: listType,
      ListItems: [block],
    }
    return arr.concat(list)
  }

  if (
    (isBulletedListItem && prevList.Type !== 'bulleted_list') ||
    (isNumberedListItem && prevList.Type !== 'numbered_list') ||
    (isToDo && prevList.Type !== 'to_do_list')
  ) {
    const list: interfaces.List = {
      Type: listType,
      ListItems: [block],
    }
    return arr.concat(list)
  }

  prevList.ListItems.push(block)

  return arr
},
  [] as (interfaces.Block | interfaces.List)[]
)

// 過濾出所有標題 (Heading)，用來給目錄 (TableOfContents) 產生錨點
let headings = rawHeadings
if (isRoot) {
  headings = blocks.filter(
    (b): b is interfaces.Block =>
      'Type' in b && ['heading_1', 'heading_2', 'heading_3'].includes(b.Type)
  )
}

const bookmarkURLs = rawBlocks
  .filter((b: interfaces.Block) =>
    ['bookmark', 'link_preview', 'embed'].includes(b.Type)
  )
  .map((b: interfaces.Block) => {
    const linkBlock = b.Bookmark || b.LinkPreview || b.Embed
    if (!linkBlock) return null
    try {
      return new URL(linkBlock.Url)
    } catch (err) {
      console.log(err)
      return null
    }
  })
  .filter((url): url is URL => url !== null && !isTweetURL(url) && !isAmazonURL(url))

const bookmarkURLMap = await buildURLToHTMLMap(bookmarkURLs)
---

{
  blocks.map((block: interfaces.Block | interfaces.List) => {
    switch (block.Type) {
      case 'paragraph':
        return <Paragraph block={block as interfaces.Block} headings={headings} />
      case 'heading_1':
        return <Heading1 block={block as interfaces.Block} headings={headings} />
      case 'heading_2':
        return <Heading2 block={block as interfaces.Block} headings={headings} />
      case 'heading_3':
        return <Heading3 block={block as interfaces.Block} headings={headings} />
      case 'table_of_contents':
        return <TableOfContents block={block as interfaces.Block} headings={headings} />
      case 'image':
        return <Image block={block as interfaces.Block} />
      case 'video':
        return <Video block={block as interfaces.Block} />
      case 'code':
        return <Code block={block as interfaces.Block} />
      case 'quote':
        return <Quote block={block as interfaces.Block} headings={headings} />
      case 'equation':
        return <Equation block={block as interfaces.Block} />
      case 'callout':
        return <Callout block={block as interfaces.Block} headings={headings} />
      case 'embed':
        return <Embed block={block as interfaces.Block} urlMap={bookmarkURLMap} />
      case 'bookmark':
      case 'link_preview':
        return <Bookmark block={block as interfaces.Block} urlMap={bookmarkURLMap} />
      case 'divider':
        return <Divider />
      case 'table':
        return <Table block={block as interfaces.Block} />
      case 'column_list':
        return <ColumnList block={block as interfaces.Block} headings={headings} />
      case 'bulleted_list':
        return <BulletedListItems block={block as interfaces.List} headings={headings} />
      case 'numbered_list':
        return (
          <NumberedListItems block={block as interfaces.List} level={level} headings={headings} />
        )
      case 'to_do_list':
        return <ToDo block={block as interfaces.List} headings={headings} />
      case 'synced_block':
        return <SyncedBlock block={block as interfaces.Block} headings={headings} />
      case 'toggle':
        return <Toggle block={block as interfaces.Block} headings={headings} />
      case 'file':
        return <File block={block as interfaces.Block} />
      case 'link_to_page':
        return <LinkToPage block={block as interfaces.Block} />
    }
    return null
  })
}
