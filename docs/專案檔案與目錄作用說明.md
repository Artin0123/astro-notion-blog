# 專案檔案與目錄作用說明

這份文件用於說明 `astro-notion-blog` 專案中各個檔案與目錄的功能，幫助開發者快速理解專案架構與資料流。

## 根目錄檔案清單

| 檔案名稱 | 作用說明 |
| --- | --- |
| `package.json` | 宣告專案依賴套件 (Astro, `@notionhq/client`, `sharp` 等) 以及定義 scripts (如 `dev`, `build:cached`)。 |
| `pnpm-lock.yaml` | pnpm 套件管理器的鎖定檔，確保在不同環境安裝的依賴版本一致。 |
| `astro.config.mjs` | Astro 框架的配置檔，用於設定 `site`、`base` (部署子路徑)、以及註冊自訂套件 (integrations) 來處理封面或圖示下載。 |
| `tsconfig.json` | TypeScript 編譯與型別檢查配置檔。 |
| `nx.json` | 設定 Nx 任務執行器，以管理 `_fetch-notion-blocks` 增量快取並減少 Notion API 的呼叫次數。 |
| `.env.example` | 環境變數的範本檔，部署或開發時應複製為 `.env` 並填入 `NOTION_API_SECRET` 與 `DATABASE_ID`。 |
| `eslint.config.mjs` | ESLint 的檢查規則配置，用於統一程式碼風格。 |
| `.gitignore` / `.nxignore` / `.prettierignore` / `.prettierrc` | 定義 Git 與各類工具的忽略清單及 Prettier 的格式化規則。 |

---

## 隱藏設定目錄

### `.github/`
存放 GitHub 相關的設定與自動化流程。
* `.github/workflows/deploy.yml`: 宣告部署自動化流程，包含 webhook (`curl`) 觸發。
* `.github/workflows/lint.yml` & `format.yml`: 每次推播或發布 PR 時執行的程式碼檢查流程。
* `.github/ISSUE_TEMPLATE/`: 存放建立 Issue 時的格式範本（Bug 回報等）。

### `.vscode/`
存放 VS Code 編輯器的專案設定。
* `.vscode/extensions.json`: 推薦給開發者安裝的 VS Code 擴充套件，例如 Astro 官方擴充。
* `.vscode/launch.json`: 提供除錯 (Debug) 設定檔。

---

## 主要目錄結構

### `docs/`
專案的技術文件存放處，包含此篇目錄作用說明，以及諸如 Notion 設定教學 (`Notion設定說明.md`)、專案架構解說 (`專案架構說明.md`)。

### `public/`
存放不需要經過 Astro 編譯處理的靜態資源，建置後會原封不動地複製到 `dist/`。
* `public/notion/`: 建置階段會將 Notion 上附掛的檔案或圖片下載至此，避免圖片失效或過期。
* `public/scripts/`: 存放外部引入的腳本，如 `fslightbox.js`。
* `public/default-og-image.png`: 預設的社群分享圖片 (Open Graph Image)。

### `scripts/`
包含在部署及編譯過程中所需要的 Node.js 執行腳本。
* `scripts/blog-contents-cache.cjs`: pre-build 腳本，透過 Nx 在建置前將 Notion 所有 Published 的文章區塊先拉取到 `tmp/`。避免 Astro build 期間同時發送大量請求導致超過 Notion 速率限制。
* `scripts/retrieve-block-children.cjs`: 實作呼叫 Notion API (`blocks.children.list`) 抓取單一 block 內容並寫入 `tmp/` 的具體腳本。

### `tmp/`
在執行 `pnpm run build:cached` 後，用來存放由 Notion API 抓取下來的 JSON 格式快取檔案，供 `src/lib/notion/client.ts` 讀取，以加速建置。

---

## `src/` (原始碼目錄)

Astro 專案的核心邏輯、頁面與組件皆存放在此處。

### 核心設定
* `src/server-constants.ts`: 定義與匯出各種常數及環境變數 (如 `DATABASE_ID`, `NOTION_API_SECRET`, 分頁數量 `NUMBER_OF_POSTS_PER_PAGE`)。此檔在伺服器端運行。

### `src/pages/`
Astro 基於檔案的路由系統 (File-based routing)。
* `src/pages/index.astro`: 網站首頁，負責呼叫 `getPosts` 等函式拉取分頁文章、標籤、推薦文章列表，並組裝首頁介面。
* `src/pages/posts/[slug].astro`: 單一文章頁面（動態路由），根據文章 slug 呼叫 `getAllBlocksByBlockId` 及 `downloadFile` 取得 Notion 區塊與附件並呈現。
* `src/pages/posts/page/[page].astro`: 提供首頁文章列表的分頁路由。
* `src/pages/posts/tag/[tag].astro` 及底下目錄: 提供依據「標籤」篩選的文章列表及分頁。
* `src/pages/feed.ts`: 負責生成部落格的 RSS Feed (`/feed` 路由)。

### `src/layouts/`
存放網頁共用版型。
* `src/layouts/Layout.astro`: 整個網站的基礎骨架（HTML, Head, 導覽列, 頁首與側邊欄等），並負責處理主題切換與 Open Graph 標籤。

### `src/lib/`
存放核心邏輯與輔助函式。
* **`src/lib/notion/client.ts`**: 與 Notion 互動的 API Client 核心。主要函式：
  * `getAllPosts`: 取得符合條件的 Pages 列表。
  * `getAllBlocksByBlockId`: 讀取區塊快取或遞迴呼叫 API，將 Notion 區塊轉換為系統所需結構。
  * `downloadFile`: 將圖片與附件下載至 `public/notion/`。
* `src/lib/blog-helpers.ts`: 處理路徑轉換、判斷社群平台 URL (Twitter, YouTube 等) 的工具函式。
* `src/lib/interfaces.ts`: 宣告 TypeScript 的型別定義 (Post, Block, Table 等)，以確保開發時的型別安全。

### `src/components/`
封裝好的 UI 或功能組件。
* **`src/components/NotionBlocks.astro`**: 作為核心分發器，迴圈讀取傳入的 Block 陣列，根據不同 `Type` 將其交由 `notion-blocks/` 內的子元件渲染。
* `src/components/notion-blocks/`: 包含各種類型 Notion Block 的獨立渲染組件（如 `Paragraph.astro`, `Image.astro`, `Code.astro`, `Callout.astro`）。
* 其他組件 (如 `PostTitle.astro`, `Pagination.astro`, `SearchModal.astro`) 負責部落格特定區域的顯示。

### `src/styles/`
存放全域與模組 CSS 樣式。
* `src/styles/blog.module.css`: 首頁或列表頁的排版樣式。
* `src/styles/notion-color.css`: 對應 Notion 的字體顏色。
* `src/styles/syntax-coloring.css`: 提供給程式碼區塊的高亮樣式表。

### `src/integrations/`
存放 Astro 自訂擴展。
* 包含 `cover-image-downloader.ts`、`public-notion-copier.ts` 等，用於在 Astro 建置的各個 hook 階段進行圖片下載與搬移處理。