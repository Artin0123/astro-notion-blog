# astro-notion-blog 專案架構說明

## 一、專案概述

astro-notion-blog 是一個以 [Notion](https://www.notion.so/) 作為內容來源的靜態部落格系統，使用 [Astro](https://astro.build/) 框架建構，在**建置階段**從 Notion API 拉取內容並生成靜態 HTML，達成極快的頁面載入速度。

---

## 二、專案架構

### 2.1 目錄結構

```
astro-notion-blog/
├── src/
│   ├── components/          # 可重用元件
│   │   ├── notion-blocks/   # Notion 區塊對應元件（標題、段落、圖片等）
│   │   ├── Post*.astro     # 文章相關元件
│   │   └── ...
│   ├── integrations/       # Astro 整合
│   │   ├── cover-image-downloader.ts    # 封面圖下載
│   │   ├── featured-image-downloader.ts # 精選圖下載
│   │   ├── custom-icon-downloader.ts     # 自訂圖示下載
│   │   └── public-notion-copier.ts      # 建置完成後複製 Notion 檔案
│   ├── lib/
│   │   ├── notion/          # Notion API 客戶端與型別
│   │   │   ├── client.ts    # 核心：拉取文章、區塊、下載檔案
│   │   │   ├── responses.ts
│   │   │   └── request-params.ts
│   │   ├── blog-helpers.ts  # 部落格工具函式
│   │   └── interfaces.ts   # 型別定義
│   ├── layouts/
│   ├── pages/               # 路由頁面
│   │   ├── index.astro      # 首頁
│   │   ├── posts/[slug].astro  # 文章頁
│   │   ├── posts/page/[page].astro  # 分頁
│   │   ├── posts/tag/[tag].astro     # 標籤頁
│   │   └── feed.ts          # RSS 訂閱
│   ├── styles/
│   └── server-constants.ts  # 環境變數與常數
├── scripts/
│   ├── blog-contents-cache.cjs   # 預先拉取 Notion 區塊到 tmp/
│   └── retrieve-block-children.cjs # 單一區塊拉取（供 nx 呼叫）
├── public/                  # 靜態資源
├── tmp/                     # Notion 區塊快取（建置時產生）
└── astro.config.mjs
```

### 2.2 資料流程

```
Notion Database (Published 文章)
        │
        ▼
┌───────────────────────────────────────────────────────────────┐
│  建置階段 (Build Time)                                         │
│  1. cache:fetch → 從 Notion API 拉取所有已發布文章的區塊到 tmp/ │
│  2. astro build → 讀取 tmp/ 與 Notion API，生成靜態 HTML       │
│  3. 下載圖片/檔案到 public/notion/                            │
│  4. 輸出到 dist/                                              │
└───────────────────────────────────────────────────────────────┘
        │
        ▼
dist/ (靜態檔案) → 部署到 Cloudflare Pages
```

### 2.3 核心機制

| 機制 | 說明 |
|------|------|
| **快取優先** | `getAllBlocksByBlockId()` 會先檢查 `tmp/{blockId}.json`，有則讀取，無則呼叫 Notion API |
| **build:cached** | 建議的建置流程：先執行 `cache:fetch` 再 `astro build`，可大幅減少 API 呼叫與建置時間 |
| **NX 任務** | `_fetch-notion-blocks` 由 nx 管理，支援增量快取（依 `last_edited_time` 判斷是否需重新拉取） |

---

## 三、使用 Cloudflare 架設

### 3.1 Cloudflare Pages 與 Workers 的差異

本專案為**純靜態網站**（SSG），建議使用 **Cloudflare Pages** 部署：

| 項目 | Cloudflare Pages | Cloudflare Workers |
|------|------------------|---------------------|
| 適用場景 | 靜態網站、Jamstack | 動態邏輯、API、SSR |
| 本專案 | ✅ 推薦 | 可選（需額外設定） |
| 設定複雜度 | 較低 | 較高 |

若你說的「CF Worker」是指 Cloudflare 生態，**Cloudflare Pages 即為最適合的選擇**，底層同樣使用 Workers 基礎設施。

### 3.2 Cloudflare Pages 部署注意事項

#### 1. 建置指令

在 Cloudflare Pages 的 Build settings 中：

- **Build command**：`pnpm run build:cached`（建議）或 `pnpm run build`
- **Build output directory**：`dist`
- **Root directory**：留空（若專案在根目錄）

#### 2. 環境變數

本地開發：複製 `.env.example` 為 `.env` 並填入 `NOTION_API_SECRET`、`DATABASE_ID`。  
詳細 Notion 設定步驟請見 [Notion設定說明.md](./Notion設定說明.md)。

Cloudflare Pages 部署時，必須在專案設定中新增：

| 變數名稱 | 說明 | 必填 |
|----------|------|------|
| `NODE_VERSION` | 建議 `20` 或以上 | ✅ |
| `NOTION_API_SECRET` | Notion Integration Token | ✅ |
| `DATABASE_ID` | Notion 資料庫 ID（從 URL 取得） | ✅ |
| `CUSTOM_DOMAIN` | 自訂網域（選填） | ❌ |
| `BASE_PATH` | 子路徑，如 `/blog`（選填） | ❌ |

#### 3. 建置時間與 API 限制

- Notion API 有速率限制，文章多時 `cache:fetch` 可能較久
- 可設定 `CACHE_CONCURRENCY` 環境變數（預設 1）控制並行數，避免觸發限流
- 建置逾時：Cloudflare Pages 預設約 15 分鐘，若文章極多需留意

#### 4. sharp 與 Node.js 原生模組

專案使用 `sharp` 處理圖片。Cloudflare Pages 建置環境為 Linux，一般可正常編譯；若遇問題，可考慮改用 `@astrojs/image` 或調整 sharp 版本。

#### 5. pnpm 支援

Cloudflare Pages 支援 pnpm。若未自動偵測，可在 Build settings 的 **Environment variables** 中新增：

- `PNPM_VERSION` = `9`（或你使用的版本）

或於 `package.json` 中設定 `packageManager` 欄位（本專案已設定）。

---

## 四、內容更新機制

### 4.1 是定期更新還是有新文章就更新？

**預設：不會自動更新**。內容是在**每次建置/部署**時從 Notion 拉取，因此：

- 新文章或修改**不會自動**反映到網站
- 必須**觸發一次新的部署**才會更新

### 4.2 常見更新方式

| 方式 | 說明 | 適用情境 |
|------|------|----------|
| **手動部署** | 在 Cloudflare Pages 後台點「Retry deployment」或重新 push 觸發 | 發文頻率低 |
| **排程部署** | 用 GitHub Actions 的 cron 定期觸發 deploy hook | 例如每週日更新 |
| **Deploy Hook** | Cloudflare 提供 Webhook URL，外部呼叫即可觸發建置 | 可搭配排程或自訂邏輯 |
| **Git push 觸發** | 每次 push 到 main 就建置 | 適合有改版時一併更新內容 |

### 4.3 設定排程更新（範例）

在 `.github/workflows/deploy.yml` 中可啟用 cron：

```yaml
on:
  schedule:
    - cron: '0 0 * * 0'   # 每週日 00:00 UTC
  workflow_dispatch:       # 手動觸發
```

並在 Cloudflare Pages 建立 **Deploy Hook**，將 URL 設為 GitHub Secrets 的 `DEPLOY_HOOK_URL`，workflow 以 `curl -X POST $DEPLOY_HOOK_URL` 觸發部署。

### 4.4 總結

- **更新時機**：由你決定（手動、排程或 push）
- **新文章**：需透過上述任一方式觸發部署後才會出現
- **建議**：發文後手動觸發一次部署，或設定每週排程

---

## 五、pnpm 使用說明

本專案已改為使用 pnpm 管理依賴。

### 5.1 常用指令

```bash
# 安裝依賴
pnpm install

# 開發
pnpm dev

# 型別檢查（檢查所有檔案的 TypeScript 錯誤）
pnpm run check

# 建置（含快取）
pnpm run build:cached

# 建置（不含快取，直接呼叫 Notion API）
pnpm run build

# 清除快取
pnpm run cache:purge
```

### 5.2 首次使用

若尚未安裝 pnpm，可透過 Corepack 啟用（Node.js 16.13+）：

```bash
corepack enable
corepack prepare pnpm@9.15.0 --activate
```

或直接安裝：`npm install -g pnpm`

---

## 六、相關連結

- [Astro 官方文件](https://docs.astro.build/)
- [Astro 部署到 Cloudflare](https://docs.astro.build/en/guides/deploy/cloudflare/)
- [Notion API 文件](https://developers.notion.com/)
- [Cloudflare Pages 文件](https://developers.cloudflare.com/pages/)
